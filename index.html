<!-- @format -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Coin Price Expectation</title>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />

    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container mt-5">
      <div class="row">
        <div id="left-side" class="col-md-7">
          <div class="logos mb-2">
            <img class="logo" src="white.png" alt="" />
            <i class="fas fa-times icon-cross"></i>
            <img class="logo" src="nextrise.png" alt="" />
          </div>
          <h1 class="event-card-title text-center mb-5">
            ë¹„íŠ¸ì½”ì¸ ê°€ê²© ì˜ˆì¸¡ ì´ë²¤íŠ¸
          </h1>
          <p class="event-card-description text-center mb-5">
            <span class="event-card-description-time">
              6ì›” 2ì¼ 19:00(KST)
            </span>
            ë¹„íŠ¸ì½”ì¸ì˜ ê°€ê²©ì„ ë§ì¶°ì£¼ì„¸ìš”! <br />
            ê°€ì¥ ë¹„ìŠ·í•˜ê²Œ ë§ì¶°ì£¼ì‹  ë¶„ë“¤ê»˜ëŠ” ìµœëŒ€ 10ë§Œì› ìƒë‹¹ì˜ ë¹„íŠ¸ì½”ì¸ì„
            ë“œë¦½ë‹ˆë‹¤. ğŸ˜„
          </p>
          <div class="mb-2">
            <h2 class="event-card-price text-center"></h2>
            <p class="event-card-warning">
              * í˜„ì¬ê°€ëŠ” 10ì´ˆë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨ë˜ë©°, ì—…ë¹„íŠ¸ BTC/KRW ì‹¤ì‹œê°„ ê°€ê²©ê³¼
              ì•½ê°„ì˜ ì˜¤ì°¨ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
          </div>
          <div class="tradingview-widget-container">
            <div id="tradingview_91d31"></div>
          </div>
        </div>
        <div id="right-side" class="col-md-5">
          <div class="event-table mt-5 text-center">
            <div class="join-title">
              <h2 class="text-center mb-5">ì°¸ì—¬ í˜„í™©</h2>
              <div id="refresh">
                <i class="fas fa-sync"></i>
              </div>
            </div>
            <div class="card-field row">
              <div class="col-md-4">
                <h5 class="card-title">í˜„ì¬ ìˆœìœ„</h5>
              </div>
              <div class="col-md-4">
                <h5 class="card-title">ì˜ˆìƒ ê°€ê²©</h5>
              </div>
              <div class="col-md-4">
                <h5 class="card-title">íœ´ëŒ€í° ë’¤ 4ìë¦¬</h5>
              </div>
            </div>
            <div id="current-status"></div>
          </div>
          <!-- ëª¨ë‹¬ ì°½ -->
          <div
            class="modal fade"
            id="myModal"
            tabindex="-1"
            role="dialog"
            aria-labelledby="myModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog" role="document">
              <div class="modal-content event-form">
                <div class="modal-header text-center">
                  <h4 class="modal-title text-center" id="myModalLabel">
                    ìƒŒë“œë±…í¬ì™€ í•¨ê»˜í•˜ëŠ” ê°€ê²©ì˜ˆì¸¡ ì´ë²¤íŠ¸ ğŸ™‹
                  </h4>
                  <button
                    type="button"
                    class="close"
                    data-dismiss="modal"
                    aria-label="Close"
                  >
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <div class="event-detail mb-3">
                    ğŸ“† ì´ë²¤íŠ¸ ê¸°ê°„ : 6/1(ëª©) 09:00 ~ 6/2(ê¸ˆ) 18:00 <br /><br />
                    ğŸ’â€â™‚ï¸ ì‚°ì • ê¸°ì¤€ : 6/2(ê¸ˆ) 19:00(KST) ê¸°ì¤€ ì—…ë¹„íŠ¸ BTC/KRW ê°€ê²©ì—
                    ê°€ì¥ ê·¼ì ‘í•œ ê°€ê²©ì„ ë§ì¶˜ ê¸°ì¤€ìœ¼ë¡œ ë“±ìˆ˜ ì‚°ì •
                    <br /><br />
                    ğŸ¯ ì´ë²¤íŠ¸ ê²½í’ˆ :<br />
                    - 1ë“±: 10ë§Œì› ìƒë‹¹ì˜ ë¹„íŠ¸ì½”ì¸ <br />
                    - 2ë“±: 5ë§Œì› ìƒë‹¹ì˜ ë¹„íŠ¸ì½”ì¸ <br />
                    - 3ë“±: 3ë§Œì› ìƒë‹¹ì˜ ë¹„íŠ¸ì½”ì¸ <br /><br />
                    ë‹¹ì²¨ì ë°œí‘œ: ìƒŒë“œë±…í¬ í™ˆí˜ì´ì§€ > ê³µì§€ì‚¬í•­ ë° ì´ë©”ì¼ ë°œì†¡<br /><br />
                    * 1ì¸ 1íšŒ ì°¸ì—¬ ê°€ëŠ¥í•˜ë©°, ì¤‘ë³µ ë‹¹ì²¨ì ë°œìƒ ì‹œ ì œì¶œìˆœìœ¼ë¡œ
                    ìˆœìœ„ê°€ ì‚°ì •ë©ë‹ˆë‹¤.<br />
                    * í˜„ì¥ ì°¸ì—¬ì½”ë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê²½ìš° ë¬´íš¨ì…ë‹ˆë‹¤.<br />
                  </div>
                  <form
                    action="https://script.google.com/macros/s/AKfycby2-u3K14exRUi0vr6d7k7PIlMdUr-XapYIW3QrGplvAfi066fIK_oE0jyVxlDfaJTo/exec?function=doPost"
                    method="post"
                  >
                    <div class="form-group">
                      <label class="event-form-list" for="code"
                        >í˜„ì¥ ì°¸ì—¬ì½”ë“œ (ë¶€ìŠ¤ ë¬¸ì˜)</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="code"
                        name="code"
                        required
                      />
                    </div>
                    <div class="form-group">
                      <label class="event-form-list" for="phone"
                        >íœ´ëŒ€í° ë²ˆí˜¸</label
                      >
                      <input
                        type="tel"
                        class="form-control"
                        id="phone"
                        name="phone"
                        placeholder="ex) 01012345678"
                        required
                      />
                    </div>
                    <div class="form-group">
                      <label class="event-form-list" for="price"
                        >ì˜ˆìƒí•˜ëŠ” ë¹„íŠ¸ì½”ì¸ ê°€ê²©(ì›)</label
                      >
                      <input
                        type="number"
                        class="form-control"
                        id="price"
                        name="price"
                        required
                        placeholder="ex) 370000000"
                      />
                    </div>
                    <div class="form-group">
                      <label class="event-form-list" for="email"
                        >ì´ë©”ì¼ ì£¼ì†Œ</label
                      >
                      <input
                        type="email"
                        class="form-control"
                        id="email"
                        name="email"
                        required
                        placeholder="ex) name@example.com"
                      />
                    </div>
                    <div class="accordion">
                      <div class="accordion-item">
                        <div class="accordion-header">
                          <span>ê°œì¸ì •ë³´ ìˆ˜ì§‘ ì´ìš© ë™ì˜</span>
                          <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="accordion-content">
                          ê²½í’ˆ ì§€ê¸‰ ëª©ì ìœ¼ë¡œ í™œìš©ë˜ë©°, ì´ë²¤íŠ¸ ì¢…ë£Œ í›„ ëª¨ë“ 
                          ì •ë³´ëŠ” íŒŒê¸°ë©ë‹ˆë‹¤.
                          <br />
                          <br />
                          í•­ëª©: ì´ë©”ì¼ ì£¼ì†Œ, ì—°ë½ì²˜
                          <br />ìˆ˜ì§‘/ì´ìš©ëª©ì : ì´ë²¤íŠ¸ ì°¸ì—¬ í™•ì¸ ë° ì´ë²¤íŠ¸ ê²½í’ˆ
                          ì§€ê¸‰ ëª©ì  <br />ë³´ìœ /ì´ìš©ê¸°ê°„: 30ì¼
                          <br />
                          <br />
                          - ìœ„ì˜ ê°œì¸ì •ë³´ ìˆ˜ì§‘/ì´ìš©ì— ëŒ€í•œ ë™ì˜ë¥¼ ê±°ë¶€í•  ê¶Œë¦¬ê°€
                          ìˆìŠµë‹ˆë‹¤.
                          <br />
                          - ê·¸ëŸ¬ë‚˜ ë™ì˜ë¥¼ ê±°ë¶€í•  ê²½ìš° ì´ë²¤íŠ¸ ì°¸ì—¬ì— ì œí•œì„ ë°›ì„
                          ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                          <br />
                          <br />
                          ìœ„ì™€ ê°™ì´ ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘/ì´ìš©í•˜ëŠ” ê²ƒì— ë™ì˜í•©ë‹ˆë‹¤.
                        </div>
                      </div>
                    </div>
                    <button
                      type="submit"
                      class="btn btn-primary mt-3"
                      id="submit-form"
                    >
                      <span id="submit-text">ì œì¶œ</span>
                      <i id="submit-spinner" class="fas fa-spinner fa-spin"></i>
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <button
      type="button"
      class="btn btn-primary floating-button"
      data-toggle="modal"
      data-target="#myModal"
    >
      ğŸ“ˆ ë°”ë¡œ ì°¸ì—¬í•˜ê¸°
    </button>
    <!-- jQuery íŒŒì¼ -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© JS íŒŒì¼ -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script
      type="text/javascript"
      src="https://s3.tradingview.com/tv.js"
    ></script>
    <script type="text/javascript">
      let main = document.querySelector("#left-side");
      let width = main.offsetWidth - 20;
      let height = main.offsetHeight + 200;

      new TradingView.widget({
        width: width,
        height: height,
        symbol: "UPBIT:BTCKRW",
        interval: "5",
        timezone: "Etc/UTC",
        theme: "dark",
        style: "1",
        locale: "en",
        toolbar_bg: "#f1f3f6",
        enable_publishing: false,
        allow_symbol_change: true,
        container_id: "tradingview_91d31"
      });
    </script>
    <script type="text/javascript">
      $(document).ready(function () {
        // ì°¸ì—¬í•˜ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ event-form íŒì—… ì—´ê¸°
        $(".open-form").click(function () {
          $("#event-form").show();
        });

        // íŒì—… ì™¸ë¶€ë¥¼ í´ë¦­í•˜ë©´ íŒì—… ë‹«ê¸°
        $(window).click(function (e) {
          if ($(e.target).is("#event-form")) {
            $("#event-form").hide();
          }
        });
      });
    </script>
    <script>
      let currentPrice;
      $(document).ready(function () {
        const fetchSpreadSheet = (currentPrice) => {
          $.ajax({
            url: "https://script.google.com/macros/s/AKfycby2-u3K14exRUi0vr6d7k7PIlMdUr-XapYIW3QrGplvAfi066fIK_oE0jyVxlDfaJTo/exec",
            success: (data) => {
              if (data.length === 0) {
                cardContainer.html(
                  '<div class="loading-text text-center">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'
                );
                return;
              }

              // currentPriceë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„° ë°°ì—´ì„ ì¬ì •ë ¬
              data.sort(
                (a, b) =>
                  Math.abs(a.price - currentPrice) -
                  Math.abs(b.price - currentPrice)
              );

              cardContainer.empty();
              const container = $("#current-status");
              data.map((result, index) => {
                const phone = String(result.phone); // ë¬¸ìì—´ë¡œ ë³€í™˜
                const card = `
          <div class="card">
            <div class="card-body">
              <div class="row">
                <div class="col-md-4">
                  <div class="card-badge" style="background-color: ${
                    index < 3 ? "#f34848" : "transparent"
                  }; color: ${index < 3 ? "white" : "black"}">${
                  index < 3 ? "ğŸ…" : ""
                } ${index + 1}ìœ„</div>
                </div>
                <div class="col-md-4">
                  <p class="card-text" id="result-rank">${addCommas(
                    result.price
                  )}ì›</p>
                </div>
                <div class="col-md-4">
                  <p class="card-text" id="result-rank">${
                    phone.slice(-4) || phone
                  }</p>
                </div>
              </div>
            </div>
          </div>`;

                container.append(card);
              });
            },
            error: () => {
              alert(
                "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
              );
            },
            method: "GET",
            data: { function: "doGet" }
          });
        };

        const fetchCurrentPrice = () => {
          $.ajax({
            url: "https://min-api.cryptocompare.com/data/pricemulti?fsyms=BTC&tsyms=KRW&e=Upbit",
            method: "GET",
            success: (data) => {
              const container = $(".event-card-price");
              currentPrice = data["BTC"]["KRW"];
              container.html(
                `<span>í˜„ì¬ê°€: ${addCommas(currentPrice)}ì›</span>`
              );
              fetchSpreadSheet(currentPrice);
            },
            error: () => {
              alert(
                "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
              );
            }
          });
        };

        fetchCurrentPrice();
        setInterval(fetchCurrentPrice, 10000); // 10ì´ˆë§ˆë‹¤ ì‹¤í–‰

        const cardContainer = $("#current-status");
        const loadingText =
          '<div class="loading-text text-center"><i class="fas fa-spinner fa-spin"></i> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        cardContainer.html(loadingText);

        $("form").submit(function (event) {
          event.preventDefault();
          const submitForm = $("#submit-form");
          const submitText = $("#submit-text");
          const submitSpinner = $("#submit-spinner");

          submitForm.prop("disabled", true);
          submitText.css("display", "none");
          submitSpinner.css("display", "block");

          $.ajax({
            url: "https://script.google.com/macros/s/AKfycby2-u3K14exRUi0vr6d7k7PIlMdUr-XapYIW3QrGplvAfi066fIK_oE0jyVxlDfaJTo/exec",
            method: "POST",
            data: $("form").serialize(),
            success: (data) => {
              submitSpinner.css("display", "none");
              submitText.css("display", "inline");
              submitText.text("ì°¸ì—¬ ì™„ë£Œ!");
              location.reload();
            }
          });
        });

        $("#refresh").click(function () {
          location.reload();
        });

        const accordionItems = $(".accordion-item");

        accordionItems.each(function () {
          const header = $(this).find(".accordion-header");
          const content = $(this).find(".accordion-content");
          const arrowIcon = $(this).find("i");

          const handleClick = () => {
            content.toggleClass("active");
            arrowIcon.toggleClass("fa-chevron-down fa-chevron-up");

            accordionItems.each(function (index, otherItem) {
              if (!$(otherItem).is($(this))) {
                const otherContent = $(otherItem).find(".accordion-content");
                const otherArrowIcon = $(otherItem).find("i");
                otherContent.removeClass("active");
                otherArrowIcon
                  .removeClass("fa-chevron-up")
                  .addClass("fa-chevron-down");
              }
            });
          };

          header.on("click", handleClick);
        });
        $("#price").on("input", function () {
          const value = $(this).val();
          if (value.length > 9) {
            $(this).val(value.slice(0, 9));
          }
        });
        $("#phone").on("input", function () {
          const value = $(this).val();
          if (value.length > 11) {
            $(this).val(value.slice(0, 11));
          }
        });
      });

      function addCommas(number) {
        const parts = number.toString().split(".");
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join(".");
      }

      function validatePhoneNumber(phoneNumber) {
        const pattern = /^[0-9]{3}-[0-9]{3,4}-[0-9]{4}$/;
        return pattern.test(phoneNumber);
      }
    </script>
  </body>
</html>
